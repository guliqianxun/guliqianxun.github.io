# Universal Serial Bus (USB) 翻译

**Device Class Definition for Human Interface Devices (HID)**

[TOC]



# 2.简介

通用串行总线（USB）是一种通信架构，可提供个人计算机（PC）使用简单的四线电缆互连各种设备的能力。 USB实际上是一条两线串行通信链路，运行在每秒1.5或12兆位（mbs）。 USB协议可以配置设备在启动时或在运行时插入它们时。 这些设备分为各种设备类别。 每个设备类定义了共同行为和具有类似功能的设备的协议。 USB设备的一些示例
下表显示了这些类：

| 设备类别   | 举例       |
| ---------- | ---------- |
| 显示       | 显示器     |
| 通信       | 调制解调器 |
| 音响       | 喇叭       |
| 大容量存储 | 硬盘       |
| 人机界面   | 数据手套   |

```
参考
有关术语和术语的更多信息，请参见附录H：词汇表定义。 本文档的其余部分假定您已阅读并了解术语表中定义的术语。
```



## 2.1 范围

本文档介绍了用于以下用途的人机接口设备（HID）类通用串行总线（USB）。 HID继承使用USB规范中的概念，这一部分并不在本文档中赘述。

```
参考
建议先阅读USB规范，以了解本文档的内容。 请参见第2.3节：相关文档。
```

HID类主要由用于帮助人类操作计算机系统的设备组成。 HID类设备的典型示例
包括：

- 键盘和指点设备-例如，标准鼠标设备，轨迹球和操纵杆。
- 面板控制-例如：旋钮，开关，按钮和滑块。
- 基于设备的控制器，例如电话，VCR遥控器，游戏或模拟设备——数据手套，油门，
  方向盘和方向舵踏板。
- 可能不需要人工干预但可以以和HID设备类相似的方式提供数据的设备，例如条形码扫描器，温度计或电压表。

许多典型的HID类设备包含了指示器，专用显示器，音频反馈，以及强制或触觉反馈。 因此，HID类的最终定义要包含对针对最终用户的各种类型输出的支持。

>注意
>需要实时交互的力反馈设备在单独的文档标题为“ USB物理接口设备（PID）类”。

```
参考
有关更多概念性信息，请参见《 USB规范》第9章。“ USB设备框架”。请参见第2.3节：相关文档。
```

## 2.2 目的

本文档旨在补充USB规范并提供HID向制造商提供构建兼容USB的设备所需的信息。 它
还指定了HID类驱动程序应如何从USB设备提取数据。HID类定义的主要目标和基础目标是：

- 尽可能紧凑以节省设备数据空间。
- 允许软件应用程序跳过未知信息。
- 具有可扩展性和鲁棒性。
- 支持嵌套和集合。
- 通过自我描述来允许广泛的软件应用。

## 2.3 相关文档

这篇文档参考了以下相关文档：

| 文档名                                               | 评论                                                      |
| ---------------------------------------------------- | --------------------------------------------------------- |
| Universal Serial Bus (USB)Specification, Version 1.0 | In particular, see Chapter 9, “USB Device Framework.”     |
| USB Class Specification for Legacy Software          |                                                           |
| USB HID Usage Supplement                             | A detailed extension of the usages listed in  Appendix A. |
| USB Physical Interface Device (PID) Specification    |                                                           |
| USB Audio Device Class                               |                                                           |


参考网站：  http://www.usb.org




# 3.管理概述

有关USB设备的信息存储在ROM的段落中（read-only memory）。 这些段称为描述符。 接口描述符可以将设备标识为属于有限数量的类之一。 HID类是本文档的重点。

USB / HID类设备使用相应的HID类驱动程序来检索和路由所有数据。

数据的路由和检索是通过检查以下对象的描述符来完成的设备及其提供的数据。

![](Resource\HID识别.png)

HID类设备描述符标识哪些其他HID类描述符是显示并指示其尺寸。 例如，报告和物理描述符。

![](Resource\HIDDescriptor.png)

报告描述符描述设备生成的每条数据以及该数据实际测量的内容。

![](Resource\ReportDescriptor.png)

举例来说，报告描述符描述一个位置或按钮的状态来定义一个个体（item）。 个体信息用于：

- 确定将输入路由到何处——例如，将输入发送到鼠标或操纵杆API。
- 允许软件将功能分配给输入——例如，使用操纵杆输入以定位坦克。

通过检查个体（统称为报告描述符）HID类驱动程序能够从HID确定数据报告的大小和组成
类设备。
物理描述符集是可选的描述符，可提供有关以下内容的信息用于告知人体用身体的哪一个部分去激活控制一个设备。

![](Resource\PhysicalDescriptor.png)

所有这些东西都可以用描述符结构去结合起来说明。

![](Resource\描述符结构.png)

本文档的其余部分记录了开发HID类设备和驱动程序的实现细节，警告和限制。

# 4. 功能特点

这一节描述了HID的功能特点：

- 类
- 子类
- 接口

## 4.1 HID类

USB设备分为以下设备类：

- 具有类似的数据传输需求。
- 共享一个类驱动程序。

举例来说，音频类设备需要同步数据通道。 HID类设备具有不同（且更简单）的传输需求。 本文档会定义HID类设备的这些不同的需求。

>注意USB设备的数据要求超出定义的类别范围必须提供USB定义的自己的类规范和驱动程序规范。 请参见第2.3节：相关文档。

USB设备可以是单个类类型，也可以由多个设备组成类。 例如，一部电话机可能使用HID，音频，和电话类。因为类实在接口描述符中定义的而非设备描述符，所以这是可能的。 这将第5.1节：设备描述符结构中进一步讨论。

USB核心规范定义了HID类代码， HID类设备在接口描述符类中的成员bInterfaceClass始终为3。

```
参考
音频类别更详细的规范参数。 请参见第2.3节：相关文档。
```

## 4.2 子类

在HID规范的早期开发过程中，需要使用子类用于识别不同类型的HID类的特定协议设备。 虽然这反映了行业当前正在使用的模型（所有设备使用类似的流行设备定义的协议），很快就发现这种方法过于严格。 也就是说，设备需要狭小地适应定义的子类，将无法提供超出由子类支持范围的任何功能。

HID委员会同意将所有子类协议归类的可能性可以定义可能的（和没有被发明）的设备。 另外，很多已知设备似乎跨越了多个类别-例如，带定位器的键盘或提供按键的定位器。 因此，HID类不使用子类来定义大多数协议。 而是一个HID类设备标识其数据协议以及其报告中提供的数据类型描述符。

一旦检测到设备，HID类驱动程序便加载和解析Report描述符。 通过报告描述符内混合的数据类型来创建已存在或新的设备的协议。

>注意 因为Report描述符的解析器包含重要且大量的代码，需要一种更简单的方法来识别设备协议需要BIOS支持的设备（引导设备）。 HID类设备使用子类部分，用于指示支持任何一种预定义协议的设备鼠标设备或键盘（即该设备可用作引导设备）。引导协议可以扩展为包括无法识别的其他数据BIOS或设备可能支持第二种首选协议，以供HID类驱动程序。

bInterfaceSubClass成员声明设备是否支持引导接口，否则为0。

### 子类代码

| Subclass Code | Description             |
| ------------- | ----------------------- |
| 0             | No Subclass             |
| 1             | Boot Interface Subclass |
| 2 - 255       | Reserved                |

```
参考
引导报告描述符在附录B：Boot Interface Descriptors。 有关HID子类和协议代码，请参见附录E：Example USB Descriptors for HID Class Devices.
```

## 4.3 协议

HID设备支持多种协议。 bInterfaceProtoco成员只有在bInterfaceSubClass定义为设备支持启动接口才有意义，否则为0。

### 协议代码

| Protocol Code | 描述   |
| ------------- | ------ |
| 0             | 无     |
| 1             | 键盘   |
| 2             | 鼠标   |
| 3 - 255       | 自定义 |

## 4.4 接口

HID类设备使用以下任一方法与HID类驱动程序进行通信：控制（默认）通道或中断通道。

![](Resource\HIDControlPipe.jpg)

控制通道用来：

- 接收和响应USB控制和类数据的请求
- 在HID类驱动轮询之发送数据（使用Get_Report 请求）
- 从主机接收数据

中断通道用来：

- 从设备接收异步（或非请求）数据
- 给设备发送低延迟数据。

中断输出通道是可选的。 如果设备声明了中断输出终端
那么输出报告将由主机通过中断发送给终端住处端点。 如果未声明中断输出终结点，则输出报告使用Set_Report（Output）通过Control端点传输到设备要求。

>注意端点0是USB设备中始终存在的控制管道。 因此，仅使用接口描述符为接口描述符描述了中断输入管道端点描述符。 实际上，几个接口描述符可以共享端点0。中断输出管道是可选的，如果声明需要附加的端点描述符。

![](Resource\EndPoint.png)

## 4.5 设备限制

该规范适用于高速和低速HID类设备。每种类型的设备都有各种限制，如第5章中所定义的通用串行总线规范。







# 5. 操作模块

本节概述了HID类设备的基本操作模型。流程图元素表示固件的信息。

## 5.1 设备描述符结构体

在最顶层，描述符包括两个信息表，称为设备描述符和字符串描述符。 一个标准的USB设备描述符指定产品ID和有关设备的其他信息。 对于例如，设备描述符字段主要包括：

- 类(class)
- 子类(Subclass)
- 供应商(Vendor)
- 产品(Product)
- 版本(Version)

![](Resource\HIDDescriptorDetail.jpg)

对于HID类设备：

- 类的类型不在设备描述符中定义，而是在接口描述符中定义。
- 子类被用来标识引导设备。（Boot Device）

>注意设备描述符中的bDeviceClass和bDeviceSubClass字段不应用于将设备标识为属于HID类。 改为使用接口描述符中的bInterfaceClass和bInterfaceSubClass字段。

```
参考
HID类驱动程序通过以下方式识别设备和功能的确切类型检查其他特定于类的描述符。 有关更多信息，请参见第6.2节：Class-Specific Descriptors。 对于描述符检索的方法，请参阅第7节：Requests
```

## 5.2 报告描述符

前面的描述符由表示以下内容的表的流程图项说明信息。 每个信息表都可以视为一个数据块。报表描述符由数据段组成，而不是数据块信息。 每条信息称为一个项目（item）。

![](Resource\item.jpg)

## 5.3 Item格式

一个item是关于设备信息的一部分。所有的item都有1byte的前缀包含它的tag, type, size。

![](Resource\itemFormat.jpg)

item可以包括可选的item数据。 tiem的数据部分的大小为由其基本类型决定。 有两种基本类型的项目：short item和 long item。 如果该item是短型的，则其可选数据大小可以为0、1、2或4个字节。 如果项目是 long item，则其bSize值始终为2。该示例说明了一个长项目的1字节前缀内的可能值。

![](F:\blog\guliqianxun.github.io\translate\Resource\longItem.jpg)

## 5.4 item解析

HID类驱动程序包含一个解析器，用于报告描述符中找到的item项。 解析器以线性方式从描述符中提取信息。解析器通描述符手机每一个已知的item状态，并将它们存储在item状态表中。 item状态表包含单个的item状态。

从解析器的角度来看，HID类设备如下图所示：

![](Resource\ItemParser.jpg)

遇到一些item被封装时，item的状态表会被移动。这些item包括所有Main，Push和Pop item。

- 找到main item后，将分配并初始化新的报告结构与当前项目状态表。 然后，所有Local item将从项目状态表中移除，但Global item会被保留。 这样，GIobal item设置了后续新Main item的默认值。 一个设备具有几种相似的控件——例如，六轴仅需要在第一个主要项目之前定义一次Global item。

>注意 当一个集合被声明的时候，Main items按顺序被关联起来。 当解析器收到一个Collection item时，使用一个新的收集器（collection）。 一个item解析器把所有在Collection item和下一个End Collection item之间的所有Main items结合起来。

- 当遇到 PUSH item 时，符纸他的 item 状态表并将其放在堆栈供以后检索
- 当遇到 POP item 后，当前的 item 状态表将替换为顶部表从堆栈。 例如：

```c
Unit (Meter), Unit Exponent (-3), Push, Unit Exponent (0)
```

解析器遇到 “PUSH” item 时，



















。 下一项更改项目状态表以米为单位（100米）。

[HID手册](Resource/HID.pdf)